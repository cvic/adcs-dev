---
import { useTranslations, type Lang } from "@/i18n";
import { getRelativeLocaleUrl } from "astro:i18n";

import SelectCounties from "./SelectCounties.astro";
import AndDivider from "./AndDivider.astro";
import GeoLocation from "./GeoLocation.astro";
import Details from "./Details.astro";
import { WHATSAPP_PHONE } from "@/consts";

const t = useTranslations(Astro.currentLocale as Lang);
const locale = Astro.currentLocale as Lang;
const submitLabel = t({ en: "Submit Request", ro: "Trimite Cererea" });
const loadingLabel = t({ en: "Sending...", ro: "Se trimite..." });
const locationLabel = t({ en: "Location", ro: "Locație" });
const detailsLabel = t({ en: "Details", ro: "Detalii" });
---

<div class="more_info_container accordion hidden" id="hiddenComponent">
  <div class="form-instructions">
    <p class="more_info">
      {t({
        en: "This page is for those who need help from the community — the response is not guaranteed.",
        ro: "Această pagină este adresată celor care au nevoie de ajutor din partea comunității — timpul de răspuns nu este garantat.",
      })}
    </p>
    <p class="more_info">
      {t({
        en: "Your browser will ask for GPS access. Allow it for the most accurate location.",
        ro: "Browser-ul va solicita acces la GPS. Confirmă accesul pentru o localizare precisă.",
      })}
    </p>
    <p class="more_info">
      {t({
        en: "Fields marked with * are mandatory.",
        ro: "Câmpurile marcate cu * sunt obligatorii.",
      })}
    </p>
    <p class="more_info">
      {t({
        en: "After submitting, volunteers in your area will be notified via WhatsApp.",
        ro: "După trimitere, membrii din zona ta vor fi notificați automat pe WhatsApp.",
      })}
    </p>
  </div>

  <form id="form-help">
    <div class="row">
      <SelectCounties selected="B" />
      <AndDivider />
      <GeoLocation />
    </div>

    <div class="row">
      <Details />
    </div>

    <!--<div class="row">-->
    <!--  <TermsAndConditions />-->
    <!--</div>-->

    <button
      type="button"
      class="btn btn-primary mt-4 w-full"
      id="submit-help-form"
      data-label={submitLabel}
      data-loading-label={loadingLabel}
    >
      {submitLabel}
    </button>
  </form>

  <script define:vars={{ WHATSAPP_PHONE, locationLabel, detailsLabel }}>
    document.addEventListener("DOMContentLoaded", () => {
      const submitButton = document.getElementById("submit-help-form");

      submitButton?.addEventListener("click", () => {
        const form = document.getElementById("form-help");

        if (!form.reportValidity()) {
          return;
        }

        const originalLabel = submitButton.dataset.label;
        const loadingLabel = submitButton.dataset.loadingLabel;
        submitButton.disabled = true;
        submitButton.textContent = loadingLabel;

        const formData = new FormData(form);
        const location = document.getElementById("coords-text").textContent.trim();

        const finalData =
          locationLabel + ": " +
          formData.get("county") +
          "\n" +
          detailsLabel + ": " +
          formData.get("details") +
          "\n" +
          location;

        const url = `https://wa.me/${WHATSAPP_PHONE}?text=${encodeURIComponent(finalData)}`;
        window.location.href = url;

        // Restore button in case navigation is blocked (e.g. popup blocker)
        setTimeout(() => {
          submitButton.disabled = false;
          submitButton.textContent = originalLabel;
        }, 3000);
      });
    });
  </script>

  <style>
    .more_info_container {
      border-radius: 8px;
      background-color: color-mix(in srgb, var(--color-main) 8%, transparent);
      border: 1px solid color-mix(in srgb, var(--color-main) 15%, transparent);
      border-top: 3px solid var(--color-theme);
      margin-block-start: var(--sp-s);
    }

    p.more_info {
      font-size: 0.82rem;
      opacity: 0.7;
      line-height: 1.55;
      margin: 0;
      padding: 0.2rem 0 0.2rem 1em;
      position: relative;

      &::before {
        content: "›";
        position: absolute;
        left: 0;
        color: var(--color-theme);
        font-weight: 700;
      }
    }

    .form-instructions {
      padding: var(--sp-s) var(--sp-m);
      border-bottom: 1px solid color-mix(in srgb, var(--color-main) 10%, transparent);
      background-color: color-mix(in srgb, var(--color-main) 3%, transparent);
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    #form-help {
      padding: var(--sp-s) var(--sp-m) var(--sp-m);
    }

    .row {
      margin-top: var(--sp-m);
      border-left: 2px solid var(--color-theme);
      padding-left: var(--sp-s);
    }

    .accordion {
      max-height: 0;
      opacity: 0;
      overflow: hidden;
      transition:
        max-height 0.5s ease,
        opacity 0.5s ease;
    }

    .accordion.show {
      max-height: 100rem;
      opacity: 1;
    }

    .hidden {
      display: none;
    }
  </style>
</div>
